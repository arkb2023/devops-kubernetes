name: Todo Apps - Build, Publish & Deploy

on:
  push:
    branches: [ '**' ] # All branches
    paths:
      - '.github/workflows/project-gke.yaml'  # Trigger on workflow change
      - 'apps/the-project/**' # trigger on manifest change 
      - 'environments/project-gke/**' # trigger on GKE environment change 
      - 'the_project/todo_app/**' # trigger on todo app change 
      - 'the_project/todo_backend/**' # trigger on todo backend app change 
  workflow_dispatch:  # Manual test
env:
  GKE_CLUSTER: dwk-cluster
  GKE_ZONE: asia-south1-a 
  PROJECT_ID: dwk-gke-480015
  REGISTRY: asia-south1-docker.pkg.dev
  REPOSITORY: dwk-gke-repository
jobs:
  build-todo-app:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GKE_SA_KEY }}
    
    - uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker
      run: gcloud auth configure-docker ${{ env.REGISTRY }}
    
    - name: BUILD Todo App
      run: |
        TODO_APP_IMAGE_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/todo-app:${{ github.sha }}"
        echo "Building: $TODO_APP_IMAGE_TAG"
        echo "TODO_APP_IMAGE_TAG=$TODO_APP_IMAGE_TAG" >> $GITHUB_ENV
        cd the_project/todo_app/
        docker build -t ${TODO_APP_IMAGE_TAG} .
    
    - name: PUBLISH Todo App
      run: |
        echo "Publishing: $TODO_APP_IMAGE_TAG"
        docker push "$TODO_APP_IMAGE_TAG"

  build-todo-backend:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GKE_SA_KEY }}
    
    - uses: google-github-actions/setup-gcloud@v2
    
    - name: Configure Docker
      run: gcloud auth configure-docker ${{ env.REGISTRY }}
    
    - name: BUILD Todo Backend
      run: |
        TODO_BACKEND_APP_IMAGE_TAG="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/todo-backend:${{ github.sha }}"
        echo "Building: $TODO_BACKEND_APP_IMAGE_TAG"
        echo "TODO_BACKEND_APP_IMAGE_TAG=$TODO_BACKEND_APP_IMAGE_TAG" >> $GITHUB_ENV      
        cd the_project/todo_backend/
        docker build -t "$TODO_BACKEND_APP_IMAGE_TAG" .
    
    - name: PUBLISH Todo Backend
      run: |
        echo "Publishing: $TODO_BACKEND_APP_IMAGE_TAG"
        docker push "$TODO_BACKEND_APP_IMAGE_TAG"

  deploy:
    needs: [build-todo-app, build-todo-backend]  # Wait for builds
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4  # Needed for kustomize files
    
    - id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GKE_SA_KEY }}
    
    - uses: google-github-actions/setup-gcloud@v2
    
    - name: Get GKE credentials  # ← CRITICAL: MISSING
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}
        project_id: ${{ env.PROJECT_ID }}
    
    - name: Update Kustomize Images & Deploy
      env:
        REGISTRY: ${{ env.REGISTRY }}
        PROJECT_ID: ${{ env.PROJECT_ID }}
        REPOSITORY: ${{ env.REPOSITORY }}
        GITHUB_SHA: ${{ github.sha }}
        BRANCH_NAME: ${{ github.ref_name }}
        #NAMESPACE: ${{ github.ref_name == 'main' && 'project' || format('project-{0}', github.ref_name) }}
      run: |
        # Generate FULL image tags
        TODO_APP_IMAGE="${REGISTRY}/${PROJECT_ID}/${REPOSITORY}/todo-app:${GITHUB_SHA}"
        TODO_BACKEND_IMAGE="${REGISTRY}/${PROJECT_ID}/${REPOSITORY}/todo-backend:${GITHUB_SHA}"
        
        echo "Deploying:"
        echo "  Todo App: $TODO_APP_IMAGE"
        echo "  Todo Backend: $TODO_BACKEND_IMAGE"

        # Sanitize branch name: feature/ui → feature-ui
        SANITIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[\/]/-/g')
        if [ "$SANITIZED_BRANCH" = "main" ]; then
          NAMESPACE="project"
        else
          NAMESPACE="$SANITIZED_BRANCH"
        fi
        
        cd environments/project-gke
        kubectl create namespace "$NAMESPACE" || true
        kubectl config set-context --current --namespace="$NAMESPACE"
        kustomize edit set namespace "$NAMESPACE"
        kustomize edit set image todo-app:latest=$TODO_APP_IMAGE
        kustomize edit set image todo-backend:latest=$TODO_BACKEND_IMAGE
        

        echo "=== Final images ==="
        #kustomize build . | grep image
        kustomize build . | grep -A3  image | grep -E "(todo-app|todo-backend)"

        # Build and deploy
        #cd -
        #kustomize build environments/project-gke | kubectl apply -f -
        kustomize build . | kubectl apply -f -

        # Verify deployment
        kubectl rollout status deployment todo-app-dep todo-backend-dep  --timeout=300s || true
        kubectl get pods,svc,gateway
        kubectl get services -o wide
        echo "kubectl get all"
        kubectl get all

        echo "Todo App Http Route: kubectl  describe httproute todo-app-route"
        kubectl  describe httproute todo-app-route |grep -A3 -e "Name:.*todo-app-route" -e "Matches:"

        echo "Todo Backend App Http Route: kubectl  describe httproute todo-backend-route"
        kubectl  describe httproute todo-backend-route |grep -A3 -e "Name:.*todo-backend-route" -e "Matches:"
        
        echo "Todo App Image: kubectl  describe deployment  todo-app-dep"
        kubectl  describe deployment  todo-app-dep |grep -A4 "Pod Template:"

        echo "Todo Backend Image: kubectl  describe deployment  todo-backend-dep"
        kubectl  describe deployment  todo-backend-dep |grep -A4 "Pod Template:"
